<!DOCTYPE html>
<html>

<head>
    <title>Prueba R√°pida Azure Vision</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        input,
        textarea {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
        }

        button {
            background: #0078d4;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
    </style>
    <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.min.js" type="text/javascript"></script>
</head>

<body>
    <h2>üîç Prueba tu Azure Vision</h2>

    <div>
        <h3>2. key:</h3>
        <input type="password" id="key" value="9VLWIg6OlA52Z0lCt1agAH3pOFL9oYE7boL2jf0OuFiVgWhuCY46JQQJ99BLACYeBjFXJ3w3AAAFACOGX4iv">
    </div>

    <div>
        <h3>2. Selecciona una imagen:</h3>
        <input type="file" id="imageInput" accept="image/*">
    </div>

    <div>
        <h3>3. Probar:</h3>
        <button onclick="sendToAzure()">üöÄ Probar Azure Vision</button>
    </div>

    <div id="result"></div>

    <script>
        const endpoint = "https://vision-licencias-usa.cognitiveservices.azure.com"; // document.getElementById('endpoint').value.trim();
       
        var key = $('#key').val();
       

        async function sendToAzure() {

            const fileInput = document.getElementById('imageInput');
            var file = fileInput.files[0];


            const response = await fetch(
                endpoint + "/vision/v3.2/read/analyze",
                //  endpoint + "/vision/v3.2/ocr",
                {
                    method: "POST",
                    headers: {
                        "Ocp-Apim-Subscription-Key": key,
                        "Content-Type": "application/octet-stream"
                    },
                    body: file // ‚úÖ binario real
                }
            );

            if (response.status > 299) {
                const err = await response.text();
                console.log(err);
            } else {

                const operationUrl = response.headers.get("Operation-Location");

                let result;

                do {
                    await new Promise(r => setTimeout(r, 1000));

                    const poll = await fetch(operationUrl, {
                        headers: {
                            "Ocp-Apim-Subscription-Key": key
                        }
                    });

                    result = await poll.json();
                    console.log("Estado:", result.status);

                } while (result.status === "running");


                if (result && result.analyzeResult && result.analyzeResult.readResults && result.analyzeResult.readResults[0] && result.analyzeResult.readResults[0].lines) {

                    var wordToInclude = ['LN', 'DNL', 'DN', 'ID', 'LIC', 'LICENSE'];

                    const filteredLines =
                        result.analyzeResult.readResults[0].lines.filter(line =>
                            line.words.some(word => {
                                const text = word.text.toUpperCase();

                                // 1. Contiene alguna de las palabras clave
                                const containsKeyword = wordToInclude.some(valid => text.includes(valid));

                                // 2. Contiene al menos un n√∫mero
                                const containsNumber = /\d/.test(text);

                                return containsKeyword;// || containsNumber;
                            })
                        );

                    const wordsText = filteredLines.map(line =>
                        line.words.map(word => word.text)
                    );

                    $('#result').html(`
                        <h3 class="success">‚úÖ ¬°Azure Vision funciona!</h3>
                        <p><strong>Texto detectado:</strong></p>
                        <pre style="width:100%; height:150px;">${JSON.stringify(wordsText, null, 2)}</pre>
                        <p><small>Respuesta completa en consola (F12)</small></p>
                    `);
                }


            }


        }

        async function testAzure() {
            const fileInput = document.getElementById('imageInput');
            const resultDiv = document.getElementById('result');

            // Validaciones
            if (!endpoint || !key) {
                resultDiv.innerHTML = '<p class="error">‚ùå Faltan credenciales</p>';
                return;
            }

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<p class="error">‚ùå Selecciona una imagen</p>';
                return;
            }

            resultDiv.innerHTML = '<p>üîÑ Procesando...</p>';

            // try {
            // 1. Convertir imagen a Base64
            const base64Image = await fileToBase64(fileInput.files[0]);
            const base64Data = base64Image.replace(/^data:image\/\w+;base64,/, '');

            const uriBase = endpoint + "/vision/v3.2/ocr"; // Older OCR API
            const params = {
                "language": "unk", // Use "unk" for auto-language detection
                "detectOrientation": "true",
            };
            // Perform the AJAX call to the REST API
            $.ajax({
                url: uriBase + "?" + $.param(params),
                beforeSend: function (xhrObj) {
                    // Request headers
                    // xhrObj.setRequestHeader("Content-Type", "application/json");
                    //  xhrObj.setRequestHeader("Content-Type", "application/octet-stream");

                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", key);
                },
                type: "POST",
                method: "POST",
                processData: false,       // üî• CLAVE
                contentType: "application/octet-stream", // üî• CLAVE
                // Request body
                data: fileInput.files[0].slice(0), //JSON.stringify({ "base64Image": base64Data }),
            })
                .done(function (data) {
                    // Show formatted JSON on webpage, or process the text
                    console.log(data);
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Output error message
                    var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                    errorString += (jqXHR.responseText === "") ? "" : jQuery.parseJSON(jqXHR.responseText).error.message;
                    console.log(errorString);
                    //  $("#outputDiv").text(errorString);
                });

            $('#result').html(`
                <h3 class="success">‚úÖ ¬°Azure Vision funciona!</h3>
                <p><strong>Texto detectado:</strong></p>
                <textarea style="width:100%; height:150px;">${text}</textarea>
                <p><small>Respuesta completa en consola (F12)</small></p>
            `);

            // resultDiv.innerHTML = `
            //     <h3 class="success">‚úÖ ¬°Azure Vision funciona!</h3>
            //     <p><strong>Texto detectado:</strong></p>
            //     <textarea style="width:100%; height:150px;">${text}</textarea>
            //     <p><small>Respuesta completa en consola (F12)</small></p>
            // `;

            // console.log('‚úÖ Respuesta Azure:', data);

            // } catch (error) {
            //     resultDiv.innerHTML = `
            //         <h3 class="error">‚ùå Error</h3>
            //         <p>${error.message}</p>
            //         <p><small>Verifica:</small></p>
            //         <ul>
            //             <li>Endpoint termina con /</li>
            //             <li>Key es correcta (32 caracteres)</li>
            //             <li>Imagen es JPG/PNG (m√°x 4MB)</li>
            //         </ul>
            //     `;
            //     console.error('‚ùå Error:', error);
            // }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

    </script>
</body>

</html>