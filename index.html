<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner PDF417 Avanzado</title>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .camera-section {
            flex: 1;
            min-width: 500px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .controls-section {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        h1, h2, h3, h4 {
            color: #333;
            margin-top: 0;
        }

        video {
            width: 100%;
            border-radius: 5px;
            background: #000;
        }

        .video-container {
            position: relative;
        }

        .overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .controls-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .control {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        label {
            font-size: 14px;
            color: #555;
        }

        input[type="range"] {
            width: 60%;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
        }

        select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            flex-grow: 1;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-primary {
            background: #007bff;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        #results {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .processing-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }

        /* Estilos para controles de ROI */
        .roi-preview {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        #roiPreviewCanvas {
            max-width: 100%;
            max-height: 200px;
            border: 1px solid #ccc;
            margin: 10px 0;
            display: block;
        }

        #roiInfo {
            font-size: 14px;
        }

        #roiInfo p {
            margin: 5px 0;
        }

        .range-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .range-group > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-group span:first-child {
            min-width: 60px;
        }

        .sub-controls {
            margin-top: 15px;
            padding-left: 10px;
            border-left: 3px solid #007bff;
        }

        .tooltip {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #007bff;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .switch-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        /* Modal de selecci√≥n manual */
        #roiSelectionModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .canvas-container {
            max-width: 800px;
            max-height: 600px;
            overflow: auto;
            margin: 15px 0;
            border: 1px solid #ccc;
        }

        #roiSelectionCanvas {
            cursor: crosshair;
            max-width: 100%;
        }

        .modal-instructions {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .modal-instructions p {
            margin: 5px 0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            z-index: 10000;
            animation: slideIn 0.3s;
        }

        .notification.success {
            background: #4CAF50;
            color: white;
        }

        .notification.error {
            background: #f44336;
            color: white;
        }

        .notification.warning {
            background: #ff9800;
            color: white;
        }

        .notification.info {
            background: #2196F3;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Modal para selecci√≥n manual de ROI -->
    <div id="roiSelectionModal" class="modal">
        <div class="modal-content">
            <h3>Seleccionar √°rea del PDF417 manualmente</h3>
            <div class="modal-instructions">
                <p>1. Arrastra para dibujar un rect√°ngulo alrededor del c√≥digo</p>
                <p>2. Ajusta los bordes arrastrando los controladores</p>
                <p>3. Haz doble clic para confirmar</p>
            </div>
            <div class="canvas-container">
                <canvas id="roiSelectionCanvas"></canvas>
            </div>
            <div class="modal-actions">
                <button id="confirmROI" class="btn-primary">‚úÖ Confirmar selecci√≥n</button>
                <button id="cancelROI" class="btn-secondary">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <section class="camera-section">
            <h1>Esc√°ner PDF417</h1>
            <div class="video-container">
                <video id="video" playsinline autoplay></video>
                <canvas id="overlay" class="overlay-canvas"></canvas>
                <div id="processingIndicator" class="processing-indicator hidden">
                    Procesando...
                </div>
            </div>
            <div class="buttons">
                <button id="startButton">Iniciar C√°mara</button>
                <button id="stopButton" disabled>Detener C√°mara</button>
                <button id="captureButton" disabled>Capturar y Escanear</button>
                <button id="toggleScan">Auto Escanear: Desactivado</button>
                <button id="uploadButton">Subir Imagen</button>
                <input type="file" id="fileInput" accept="image/*" hidden>
            </div>
            <div id="results">
                Resultados aparecer√°n aqu√≠...
            </div>
        </section>

        <section class="controls-section">
            <h2>Controles de Procesamiento</h2>
            <p>Activa/desactiva y ajusta los filtros para mejorar la detecci√≥n.</p>

            <div class="controls-group">
                <h3>üîç Detecci√≥n y Recorte Autom√°tico</h3>
                <div class="switch-label">
                    <label class="switch">
                        <input type="checkbox" id="autoROIEnabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="label">Detecci√≥n autom√°tica de PDF417</span>
                </div>
                <div class="tooltip">‚ìò Detecta y recorta autom√°ticamente el √°rea del c√≥digo</div>
                
                <div id="roiControls" class="sub-controls">
                    <div class="control">
                        <label>Margen de recorte:</label>
                        <input type="range" id="roiMargin" min="0" max="50" value="15" step="1">
                        <span id="roiMarginValue">15px</span>
                    </div>

                    <div class="control">
                        <label>Sensibilidad de detecci√≥n:</label>
                        <input type="range" id="roiConfidence" min="0.1" max="1" value="0.7" step="0.1">
                        <span id="roiConfidenceValue">70%</span>
                    </div>

                    <div class="control">
                        <label>
                            <input type="checkbox" id="roiMultiScan" checked>
                            Escaneo m√∫ltiple
                        </label>
                    </div>

                    <div class="control">
                        <label>
                            <input type="checkbox" id="roiDebugOverlay">
                            Mostrar √°rea detectada
                        </label>
                    </div>

                    <div class="control">
                        <label>Tama√±o m√≠nimo del c√≥digo:</label>
                        <div class="range-group">
                            <div>
                                <span>Ancho:</span>
                                <input type="range" id="roiMinWidth" min="50" max="300" value="100" step="10">
                                <span id="roiMinWidthValue">100px</span>
                            </div>
                            <div>
                                <span>Alto:</span>
                                <input type="range" id="roiMinHeight" min="20" max="150" value="30" step="5">
                                <span id="roiMinHeightValue">30px</span>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="manualROIButton" class="btn-secondary">
                            ‚úèÔ∏è Seleccionar √°rea manualmente
                        </button>
                        <button id="resetROIButton" class="btn-secondary">
                            üîÑ Restablecer recorte
                        </button>
                        <button id="testROIButton" class="btn-info">
                            üîç Probar detecci√≥n
                        </button>
                    </div>

                    <div class="roi-preview">
                        <h4>Vista previa del √°rea detectada:</h4>
                        <canvas id="roiPreviewCanvas"></canvas>
                        <div id="roiInfo">
                            <p>Estado: <span id="roiStatus">Esperando imagen...</span></p>
                            <p>Confianza: <span id="roiConfidenceDisplay">-</span></p>
                            <p>Dimensi√≥n: <span id="roiDimensions">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros b√°sicos -->
            <div class="controls-group">
                <h3>Filtros B√°sicos</h3>

                <div class="control">
                    <label for="grayscaleEnabled">Escala de grises</label>
                    <input type="checkbox" id="grayscaleEnabled" checked>
                </div>
                <div class="control">
                    <label for="grayscaleMethod">M√©todo:</label>
                    <select id="grayscaleMethod">
                        <option value="luminance">Luminancia</option>
                        <option value="average">Promedio</option>
                        <option value="lightness">Claridad</option>
                    </select>
                </div>

                <div class="control">
                    <label for="illuminationEnabled">Correcci√≥n de Iluminaci√≥n</label>
                    <input type="checkbox" id="illuminationEnabled" checked>
                </div>
                <div class="control">
                    <label for="illuminationStrength">Fuerza:</label>
                    <input type="range" id="illuminationStrength" min="0" max="1" step="0.1" value="0.7">
                </div>

                <div class="control">
                    <label for="claheEnabled">CLAHE (Contraste Adaptativo)</label>
                    <input type="checkbox" id="claheEnabled" checked>
                </div>
                <div class="control">
                    <label for="claheContrast">Contraste CLAHE:</label>
                    <input type="range" id="claheContrast" min="0.1" max="3" step="0.1" value="1.0">
                </div>

                <div class="control">
                    <label for="denoisingEnabled">Reducci√≥n de Ruido</label>
                    <input type="checkbox" id="denoisingEnabled" checked>
                </div>
                <div class="control">
                    <label for="denoisingStrength">Fuerza:</label>
                    <input type="range" id="denoisingStrength" min="0" max="1" step="0.1" value="0.5">
                </div>
            </div>

            <!-- Binarizaci√≥n -->
            <div class="controls-group">
                <h3>Binarizaci√≥n</h3>

                <div class="control">
                    <label for="adaptiveThresholdEnabled">Umbral Adaptativo</label>
                    <input type="checkbox" id="adaptiveThresholdEnabled" checked>
                </div>
                <div class="control">
                    <label for="thresholdMethod">M√©todo:</label>
                    <select id="thresholdMethod">
                        <option value="sauvola">Sauvola</option>
                        <option value="niblack">Niblack</option>
                        <option value="bernsen">Bernsen</option>
                    </select>
                </div>
                <div class="control">
                    <label for="windowSize">Tama√±o de Ventana:</label>
                    <input type="range" id="windowSize" min="3" max="31" step="2" value="15">
                </div>
                <div class="control">
                    <label for="kValue">Par√°metro k:</label>
                    <input type="range" id="kValue" min="0" max="0.5" step="0.01" value="0.2">
                </div>
            </div>

            <!-- Filtros Avanzados -->
            <div class="controls-group">
                <h3>Filtros Avanzados</h3>

                <div class="control">
                    <label for="shadowRemovalEnabled">Remoci√≥n de Sombras</label>
                    <input type="checkbox" id="shadowRemovalEnabled" checked>
                </div>
                <div class="control">
                    <label for="shadowIntensity">Intensidad:</label>
                    <input type="range" id="shadowIntensity" min="0" max="1" step="0.1" value="0.8">
                </div>

                <div class="control">
                    <label for="reflectionRemovalEnabled">Remoci√≥n de Reflejos</label>
                    <input type="checkbox" id="reflectionRemovalEnabled" checked>
                </div>
                <div class="control">
                    <label for="reflectionSensitivity">Sensibilidad:</label>
                    <input type="range" id="reflectionSensitivity" min="0" max="1" step="0.1" value="0.6">
                </div>

                <div class="control">
                    <label for="edgeEnhancementEnabled">Mejora de Bordes</label>
                    <input type="checkbox" id="edgeEnhancementEnabled" checked>
                </div>
                <div class="control">
                    <label for="edgeStrength">Fuerza:</label>
                    <input type="range" id="edgeStrength" min="0" max="1" step="0.1" value="0.4">
                </div>
            </div>

            <!-- Controles de C√°mara -->
            <div class="controls-group">
                <h3>Controles de C√°mara</h3>

                <div class="control">
                    <label for="brightness">Brillo:</label>
                    <input type="range" id="brightness" min="-1" max="1" step="0.1" value="0">
                </div>
                <div class="control">
                    <label for="contrast">Contraste:</label>
                    <input type="range" id="contrast" min="0" max="2" step="0.1" value="1">
                </div>
                <div class="control">
                    <label for="saturation">Saturaci√≥n:</label>
                    <input type="range" id="saturation" min="0" max="2" step="0.1" value="1">
                </div>
                <div class="control">
                    <label for="sharpness">Nitidez:</label>
                    <input type="range" id="sharpness" min="-1" max="1" step="0.1" value="0">
                </div>
                <div class="control">
                    <label for="zoom">Zoom:</label>
                    <input type="range" id="zoom" min="1" max="5" step="0.1" value="1">
                </div>
            </div>

            <!-- Botones de Configuraci√≥n -->
            <div class="buttons">
                <button id="resetSettings">Restaurar Valores por Defecto</button>
                <button id="saveSettings">Guardar Configuraci√≥n</button>
                <button id="loadSettings">Cargar Configuraci√≥n Guardada</button>
            </div>
        </section>
    </div>

    <script>
        // ==================== CLASE PRINCIPAL ====================
        class PDF417Processor {
            constructor() {
                this.config = {
                    grayscale: { enabled: true, method: 'luminance' },
                    illuminationCorrection: { enabled: true, strength: 0.7 },
                    clahe: { enabled: true, contrast: 1.0 },
                    denoising: { enabled: true, strength: 0.5 },
                    adaptiveThreshold: {
                        enabled: true,
                        method: 'sauvola',
                        windowSize: 15,
                        k: 0.2
                    },
                    shadowRemoval: { enabled: true, intensity: 0.8 },
                    reflectionRemoval: { enabled: true, sensitivity: 0.6 },
                    edgeEnhancement: { enabled: true, strength: 0.4 },
                    autoROI: {
                        enabled: true,
                        margin: 15,
                        minWidth: 100,
                        minHeight: 30,
                        confidenceThreshold: 0.7,
                        showDebugOverlay: false
                    }
                };
                
                this.lastROI = null;
                this.loadSettings();
            }

            loadSettings() {
                const saved = localStorage.getItem('pdf417_processor_config');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    for (let key in parsed) {
                        if (this.config[key]) {
                            Object.assign(this.config[key], parsed[key]);
                        }
                    }
                }
            }

            saveSettings() {
                localStorage.setItem('pdf417_processor_config', JSON.stringify(this.config));
            }

            resetSettings() {
                this.config = {
                    grayscale: { enabled: true, method: 'luminance' },
                    illuminationCorrection: { enabled: true, strength: 0.7 },
                    clahe: { enabled: true, contrast: 1.0 },
                    denoising: { enabled: true, strength: 0.5 },
                    adaptiveThreshold: {
                        enabled: true,
                        method: 'sauvola',
                        windowSize: 15,
                        k: 0.2
                    },
                    shadowRemoval: { enabled: true, intensity: 0.8 },
                    reflectionRemoval: { enabled: true, sensitivity: 0.6 },
                    edgeEnhancement: { enabled: true, strength: 0.4 },
                    autoROI: {
                        enabled: true,
                        margin: 15,
                        minWidth: 100,
                        minHeight: 30,
                        confidenceThreshold: 0.7,
                        showDebugOverlay: false
                    }
                };
                this.saveSettings();
            }

            updateFromUI() {
                this.config.grayscale.enabled = document.getElementById('grayscaleEnabled').checked;
                this.config.grayscale.method = document.getElementById('grayscaleMethod').value;
                this.config.illuminationCorrection.enabled = document.getElementById('illuminationEnabled').checked;
                this.config.illuminationCorrection.strength = parseFloat(document.getElementById('illuminationStrength').value);
                this.config.clahe.enabled = document.getElementById('claheEnabled').checked;
                this.config.clahe.contrast = parseFloat(document.getElementById('claheContrast').value);
                this.config.denoising.enabled = document.getElementById('denoisingEnabled').checked;
                this.config.denoising.strength = parseFloat(document.getElementById('denoisingStrength').value);
                this.config.adaptiveThreshold.enabled = document.getElementById('adaptiveThresholdEnabled').checked;
                this.config.adaptiveThreshold.method = document.getElementById('thresholdMethod').value;
                this.config.adaptiveThreshold.windowSize = parseInt(document.getElementById('windowSize').value);
                this.config.adaptiveThreshold.k = parseFloat(document.getElementById('kValue').value);
                this.config.shadowRemoval.enabled = document.getElementById('shadowRemovalEnabled').checked;
                this.config.shadowRemoval.intensity = parseFloat(document.getElementById('shadowIntensity').value);
                this.config.reflectionRemoval.enabled = document.getElementById('reflectionRemovalEnabled').checked;
                this.config.reflectionRemoval.sensitivity = parseFloat(document.getElementById('reflectionSensitivity').value);
                this.config.edgeEnhancement.enabled = document.getElementById('edgeEnhancementEnabled').checked;
                this.config.edgeEnhancement.strength = parseFloat(document.getElementById('edgeStrength').value);
                
                this.config.autoROI.enabled = document.getElementById('autoROIEnabled').checked;
                this.config.autoROI.margin = parseInt(document.getElementById('roiMargin').value);
                this.config.autoROI.confidenceThreshold = parseFloat(document.getElementById('roiConfidence').value);
                this.config.autoROI.minWidth = parseInt(document.getElementById('roiMinWidth').value);
                this.config.autoROI.minHeight = parseInt(document.getElementById('roiMinHeight').value);
                this.config.autoROI.showDebugOverlay = document.getElementById('roiDebugOverlay').checked;
                
                this.saveSettings();
            }

            updateUIFromConfig() {
                document.getElementById('grayscaleEnabled').checked = this.config.grayscale.enabled;
                document.getElementById('grayscaleMethod').value = this.config.grayscale.method;
                document.getElementById('illuminationEnabled').checked = this.config.illuminationCorrection.enabled;
                document.getElementById('illuminationStrength').value = this.config.illuminationCorrection.strength;
                document.getElementById('claheEnabled').checked = this.config.clahe.enabled;
                document.getElementById('claheContrast').value = this.config.clahe.contrast;
                document.getElementById('denoisingEnabled').checked = this.config.denoising.enabled;
                document.getElementById('denoisingStrength').value = this.config.denoising.strength;
                document.getElementById('adaptiveThresholdEnabled').checked = this.config.adaptiveThreshold.enabled;
                document.getElementById('thresholdMethod').value = this.config.adaptiveThreshold.method;
                document.getElementById('windowSize').value = this.config.adaptiveThreshold.windowSize;
                document.getElementById('kValue').value = this.config.adaptiveThreshold.k;
                document.getElementById('shadowRemovalEnabled').checked = this.config.shadowRemoval.enabled;
                document.getElementById('shadowIntensity').value = this.config.shadowRemoval.intensity;
                document.getElementById('reflectionRemovalEnabled').checked = this.config.reflectionRemoval.enabled;
                document.getElementById('reflectionSensitivity').value = this.config.reflectionRemoval.sensitivity;
                document.getElementById('edgeEnhancementEnabled').checked = this.config.edgeEnhancement.enabled;
                document.getElementById('edgeStrength').value = this.config.edgeEnhancement.strength;
                
                document.getElementById('autoROIEnabled').checked = this.config.autoROI.enabled;
                document.getElementById('roiMargin').value = this.config.autoROI.margin;
                document.getElementById('roiConfidence').value = this.config.autoROI.confidenceThreshold;
                document.getElementById('roiMinWidth').value = this.config.autoROI.minWidth;
                document.getElementById('roiMinHeight').value = this.config.autoROI.minHeight;
                document.getElementById('roiDebugOverlay').checked = this.config.autoROI.showDebugOverlay;
            }

            // ==================== M√âTODOS DE PROCESAMIENTO ====================
            grayscale(imageData, method = 'luminance') {
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    let gray;
                    switch (method) {
                        case 'luminance': gray = 0.299 * r + 0.587 * g + 0.114 * b; break;
                        case 'average': gray = (r + g + b) / 3; break;
                        case 'lightness': gray = (Math.max(r, g, b) + Math.min(r, g, b)) / 2; break;
                        default: gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    }
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                return imageData;
            }

            correctIllumination(imageData, strength) {
                const data = imageData.data;
                const histogram = new Array(256).fill(0);
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i];
                    histogram[Math.floor(gray)]++;
                }
                const cdf = new Array(256).fill(0);
                cdf[0] = histogram[0];
                for (let i = 1; i < 256; i++) {
                    cdf[i] = cdf[i - 1] + histogram[i];
                }
                const cdfMin = cdf.find(val => val > 0);
                const cdfMax = cdf[255];
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i];
                    const cdfValue = cdf[Math.floor(gray)];
                    const newGray = ((cdfValue - cdfMin) / (cdfMax - cdfMin)) * 255;
                    data[i] = data[i + 1] = data[i + 2] = (1 - strength) * gray + strength * newGray;
                }
                return imageData;
            }

            applyCLAHE(imageData, contrast) {
                const data = imageData.data;
                const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    data[i] = this.clamp(factor * (r - 128) + 128, 0, 255);
                    data[i + 1] = this.clamp(factor * (g - 128) + 128, 0, 255);
                    data[i + 2] = this.clamp(factor * (b - 128) + 128, 0, 255);
                }
                return imageData;
            }

            denoise(imageData, strength) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                const kernelSize = Math.max(3, Math.floor(strength * 5));
                const halfKernel = Math.floor(kernelSize / 2);
                const tempData = new Uint8ClampedArray(data);

                for (let y = halfKernel; y < height - halfKernel; y++) {
                    for (let x = halfKernel; x < width - halfKernel; x++) {
                        const idx = (y * width + x) * 4;
                        let rValues = [], gValues = [], bValues = [];
                        for (let ky = -halfKernel; ky <= halfKernel; ky++) {
                            for (let kx = -halfKernel; kx <= halfKernel; kx++) {
                                const kidx = ((y + ky) * width + (x + kx)) * 4;
                                rValues.push(tempData[kidx]);
                                gValues.push(tempData[kidx + 1]);
                                bValues.push(tempData[kidx + 2]);
                            }
                        }
                        rValues.sort((a, b) => a - b);
                        gValues.sort((a, b) => a - b);
                        bValues.sort((a, b) => a - b);
                        const medianIndex = Math.floor(rValues.length / 2);
                        const blend = strength;
                        data[idx] = (1 - blend) * data[idx] + blend * rValues[medianIndex];
                        data[idx + 1] = (1 - blend) * data[idx + 1] + blend * gValues[medianIndex];
                        data[idx + 2] = (1 - blend) * data[idx + 2] + blend * bValues[medianIndex];
                    }
                }
                return imageData;
            }

            sauvolaThreshold(imageData, windowSize, k) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                const tempData = new Uint8ClampedArray(data);
                const halfWindow = Math.floor(windowSize / 2);
                const r = 128;

                for (let y = halfWindow; y < height - halfWindow; y++) {
                    for (let x = halfWindow; x < width - halfWindow; x++) {
                        let sum = 0;
                        let sumSq = 0;
                        let count = 0;
                        for (let wy = -halfWindow; wy <= halfWindow; wy++) {
                            for (let wx = -halfWindow; wx <= halfWindow; wx++) {
                                const idx = ((y + wy) * width + (x + wx)) * 4;
                                const gray = tempData[idx];
                                sum += gray;
                                sumSq += gray * gray;
                                count++;
                            }
                        }
                        const mean = sum / count;
                        const variance = (sumSq / count) - (mean * mean);
                        const stdDev = Math.sqrt(variance);
                        const threshold = mean * (1 + k * ((stdDev / r) - 1));
                        const idx = (y * width + x) * 4;
                        const gray = tempData[idx];
                        const binary = gray > threshold ? 255 : 0;
                        data[idx] = data[idx + 1] = data[idx + 2] = binary;
                    }
                }
                return imageData;
            }

            removeShadows(imageData, intensity) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                const illumination = new Float32Array(width * height);
                const kernelSize = 31;
                const halfKernel = Math.floor(kernelSize / 2);

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        let sum = 0;
                        let count = 0;
                        for (let ky = -halfKernel; ky <= halfKernel; ky++) {
                            for (let kx = -halfKernel; kx <= halfKernel; kx++) {
                                const ny = y + ky;
                                const nx = x + kx;
                                if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                    const idx = (ny * width + nx) * 4;
                                    sum += data[idx];
                                    count++;
                                }
                            }
                        }
                        illumination[y * width + x] = sum / count;
                    }
                }

                for (let i = 0; i < data.length; i += 4) {
                    const x = (i / 4) % width;
                    const y = Math.floor((i / 4) / width);
                    const illum = illumination[y * width + x];
                    const factor = 128 / (illum + 1);
                    const gray = data[i];
                    if (gray < 128) {
                        const corrected = gray * factor * intensity + gray * (1 - intensity);
                        data[i] = data[i + 1] = data[i + 2] = this.clamp(corrected, 0, 255);
                    }
                }
                return imageData;
            }

            removeReflections(imageData, sensitivity) {
                const data = imageData.data;
                const threshold = 250 - (sensitivity * 50);
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    if (r > threshold && g > threshold && b > threshold) {
                        const width = imageData.width;
                        const height = imageData.height;
                        const x = (i / 4) % width;
                        const y = Math.floor((i / 4) / width);
                        if (x > 0 && x < width - 1 && y > 0 && y < height - 1) {
                            let sumR = 0, sumG = 0, sumB = 0, count = 0;
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    if (dx === 0 && dy === 0) continue;
                                    const nIdx = ((y + dy) * width + (x + dx)) * 4;
                                    sumR += data[nIdx];
                                    sumG += data[nIdx + 1];
                                    sumB += data[nIdx + 2];
                                    count++;
                                }
                            }
                            data[i] = sumR / count;
                            data[i + 1] = sumG / count;
                            data[i + 2] = sumB / count;
                        }
                    }
                }
                return imageData;
            }

            enhanceEdges(imageData, strength) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                const tempData = new Uint8ClampedArray(data);
                const kernel = [[0, -1, 0], [-1, 4, -1], [0, -1, 0]];
                const kernelSum = 1;

                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let sumR = 0, sumG = 0, sumB = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4;
                                const weight = kernel[ky + 1][kx + 1];
                                sumR += tempData[idx] * weight;
                                sumG += tempData[idx + 1] * weight;
                                sumB += tempData[idx + 2] * weight;
                            }
                        }
                        const idx = (y * width + x) * 4;
                        data[idx] = this.clamp(tempData[idx] + strength * sumR / kernelSum, 0, 255);
                        data[idx + 1] = this.clamp(tempData[idx + 1] + strength * sumG / kernelSum, 0, 255);
                        data[idx + 2] = this.clamp(tempData[idx + 2] + strength * sumB / kernelSum, 0, 255);
                    }
                }
                return imageData;
            }

            clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }

            processImage(imageData) {
                let processed = imageData;
                if (this.config.grayscale.enabled) processed = this.grayscale(processed, this.config.grayscale.method);
                if (this.config.illuminationCorrection.enabled) processed = this.correctIllumination(processed, this.config.illuminationCorrection.strength);
                if (this.config.clahe.enabled) processed = this.applyCLAHE(processed, this.config.clahe.contrast);
                if (this.config.denoising.enabled) processed = this.denoise(processed, this.config.denoising.strength);
                if (this.config.shadowRemoval.enabled) processed = this.removeShadows(processed, this.config.shadowRemoval.intensity);
                if (this.config.reflectionRemoval.enabled) processed = this.removeReflections(processed, this.config.reflectionRemoval.sensitivity);
                if (this.config.edgeEnhancement.enabled) processed = this.enhanceEdges(processed, this.config.edgeEnhancement.strength);
                if (this.config.adaptiveThreshold.enabled) processed = this.sauvolaThreshold(processed, this.config.adaptiveThreshold.windowSize, this.config.adaptiveThreshold.k);
                return processed;
            }

            // ==================== FUNCIONES DE ROI ====================
            async processImageWithROI(imageElement) {
                try {
                    if (this.config.autoROI.enabled) {
                        const roi = await this.detectPDF417ROI(imageElement);
                        if (roi && roi.confidence > this.config.autoROI.confidenceThreshold) {
                            this.lastROI = roi;
                            const croppedCanvas = this.cropToROI(imageElement, roi);
                            const ctx = croppedCanvas.getContext('2d');
                            let imageData = ctx.getImageData(0, 0, croppedCanvas.width, croppedCanvas.height);
                            imageData = this.processImage(imageData);
                            ctx.putImageData(imageData, 0, 0);
                            return { canvas: croppedCanvas, roi: roi, cropped: true };
                        }
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = imageElement.width || imageElement.videoWidth;
                    canvas.height = imageElement.height || imageElement.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    imageData = this.processImage(imageData);
                    ctx.putImageData(imageData, 0, 0);
                    return { canvas: canvas, roi: null, cropped: false };
                    
                } catch (error) {
                    console.error("Error en procesamiento con ROI:", error);
                    throw error;
                }
            }

            cropToROI(imageElement, roi) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const x = Math.round(roi.x);
                const y = Math.round(roi.y);
                const width = Math.round(roi.width);
                const height = Math.round(roi.height);
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(imageElement, x, y, width, height, 0, 0, width, height);
                return canvas;
            }

            async detectPDF417ROI(imageElement) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 0.5;
                    const width = imageElement.width || imageElement.videoWidth;
                    const height = imageElement.height || imageElement.videoHeight;
                    canvas.width = width * scale;
                    canvas.height = height * scale;
                    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    let minX = canvas.width, maxX = 0;
                    let minY = canvas.height, maxY = 0;
                    let found = false;
                    
                    for (let y = 0; y < canvas.height; y += 2) {
                        for (let x = 0; x < canvas.width; x += 2) {
                            const idx = (y * canvas.width + x) * 4;
                            const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                            if (brightness < 100) {
                                if (x < minX) minX = x;
                                if (x > maxX) maxX = x;
                                if (y < minY) minY = y;
                                if (y > maxY) maxY = y;
                                found = true;
                            }
                        }
                    }
                    
                    if (!found || (maxX - minX) < 10 || (maxY - minY) < 10) {
                        resolve(null);
                        return;
                    }
                    
                    const roi = {
                        x: Math.max(0, (minX / scale) - this.config.autoROI.margin),
                        y: Math.max(0, (minY / scale) - this.config.autoROI.margin),
                        width: Math.min(width, ((maxX - minX) / scale) + (this.config.autoROI.margin * 2)),
                        height: Math.min(height, ((maxY - minY) / scale) + (this.config.autoROI.margin * 2)),
                        confidence: 0.8
                    };
                    
                    resolve(roi);
                });
            }
        }

        // ==================== VARIABLES GLOBALES ====================
        const processor = new PDF417Processor();
        let stream = null;
        let autoScanInterval = null;
        let isAutoScanning = false;
        const codeReader = new ZXing.BrowserPDF417Reader();
        const currentImage = document.createElement('img');
        currentImage.id = 'currentImage';
        currentImage.style.display = 'none';
        document.body.appendChild(currentImage);

        // Elementos del DOM
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const overlayCtx = overlay.getContext('2d');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const captureButton = document.getElementById('captureButton');
        const toggleScanButton = document.getElementById('toggleScan');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const resultsDiv = document.getElementById('results');
        const processingIndicator = document.getElementById('processingIndicator');

        // ==================== FUNCIONES DE C√ÅMARA ====================
        async function startCamera() {
            try {
                const constraints = {
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'environment' },
                    audio: false
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    overlay.width = video.videoWidth;
                    overlay.height = video.videoHeight;
                };
                startButton.disabled = true;
                stopButton.disabled = false;
                captureButton.disabled = false;
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                showNotification('No se pudo acceder a la c√°mara: ' + err.message, 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                startButton.disabled = false;
                stopButton.disabled = true;
                captureButton.disabled = true;
                stopAutoScan();
            }
        }

        // ==================== FUNCIONES DE ESCANEO ====================
        function showProcessing(show) {
            processingIndicator.classList.toggle('hidden', !show);
        }

        async function captureAndScan() {
            if (!stream) {
                showNotification('Inicia la c√°mara primero', 'warning');
                return;
            }

            showProcessing(true);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            currentImage.src = canvas.toDataURL();
            currentImage.width = canvas.width;
            currentImage.height = canvas.height;
            processor.updateFromUI();

            let resultCanvas;
            let roiResult;
            if (processor.config.autoROI.enabled) {
                roiResult = await processor.processImageWithROI(canvas);
                resultCanvas = roiResult.canvas;
                if (roiResult.roi) {
                    updateROIPreview(roiResult.roi);
                    if (processor.config.autoROI.showDebugOverlay) drawROIOverlay(canvas, roiResult.roi);
                } else updateROIPreview(null);
            } else {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                imageData = processor.processImage(imageData);
                resultCanvas = document.createElement('canvas');
                resultCanvas.width = canvas.width;
                resultCanvas.height = canvas.height;
                const resultCtx = resultCanvas.getContext('2d');
                resultCtx.putImageData(imageData, 0, 0);
            }

            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            overlayCtx.drawImage(resultCanvas, 0, 0, overlay.width, overlay.height);

            try {
                const result = await codeReader.decodeFromCanvas(resultCanvas);
                showResults(result.text);
            } catch (err) {
                console.log('No se pudo decodificar:', err);
                showResults('No se detect√≥ c√≥digo PDF417. Intenta ajustar los filtros.');
            }
            showProcessing(false);
        }

        function startAutoScan() {
            if (isAutoScanning) return;
            isAutoScanning = true;
            toggleScanButton.textContent = 'Auto Escanear: Activado';
            autoScanInterval = setInterval(captureAndScan, 2000);
        }

        function stopAutoScan() {
            isAutoScanning = false;
            if (autoScanInterval) clearInterval(autoScanInterval);
            toggleScanButton.textContent = 'Auto Escanear: Desactivado';
        }

        function toggleAutoScan() {
            isAutoScanning ? stopAutoScan() : startAutoScan();
        }

        function showResults(text) {
            resultsDiv.textContent = text;
            resultsDiv.style.background = '#d4edda';
            setTimeout(() => resultsDiv.style.background = '#e9ecef', 1000);
        }

        // ==================== FUNCIONES DE ROI ====================
        function initializeROIControls() {
            const autoROIEnabled = document.getElementById('autoROIEnabled');
            const roiControls = document.getElementById('roiControls');
            const roiMargin = document.getElementById('roiMargin');
            const roiMarginValue = document.getElementById('roiMarginValue');
            const roiConfidence = document.getElementById('roiConfidence');
            const roiConfidenceValue = document.getElementById('roiConfidenceValue');
            const roiDebugOverlay = document.getElementById('roiDebugOverlay');
            const roiMinWidth = document.getElementById('roiMinWidth');
            const roiMinWidthValue = document.getElementById('roiMinWidthValue');
            const roiMinHeight = document.getElementById('roiMinHeight');
            const roiMinHeightValue = document.getElementById('roiMinHeightValue');
            const manualROIButton = document.getElementById('manualROIButton');
            const resetROIButton = document.getElementById('resetROIButton');
            const testROIButton = document.getElementById('testROIButton');

            autoROIEnabled.addEventListener('change', (e) => {
                processor.config.autoROI.enabled = e.target.checked;
                roiControls.style.display = e.target.checked ? 'block' : 'none';
                processor.saveSettings();
            });

            roiMargin.addEventListener('input', (e) => {
                processor.config.autoROI.margin = parseInt(e.target.value);
                roiMarginValue.textContent = e.target.value + 'px';
                processor.saveSettings();
            });

            roiConfidence.addEventListener('input', (e) => {
                processor.config.autoROI.confidenceThreshold = parseFloat(e.target.value);
                roiConfidenceValue.textContent = Math.round(e.target.value * 100) + '%';
                processor.saveSettings();
            });

            roiDebugOverlay.addEventListener('change', (e) => {
                processor.config.autoROI.showDebugOverlay = e.target.checked;
                processor.saveSettings();
            });

            roiMinWidth.addEventListener('input', (e) => {
                processor.config.autoROI.minWidth = parseInt(e.target.value);
                roiMinWidthValue.textContent = e.target.value + 'px';
                processor.saveSettings();
            });

            roiMinHeight.addEventListener('input', (e) => {
                processor.config.autoROI.minHeight = parseInt(e.target.value);
                roiMinHeightValue.textContent = e.target.value + 'px';
                processor.saveSettings();
            });

            manualROIButton.addEventListener('click', openManualROISelection);
            resetROIButton.addEventListener('click', () => {
                processor.lastROI = null;
                updateROIPreview(null);
                showNotification('Recorte restablecido', 'info');
            });
            testROIButton.addEventListener('click', testROIDetection);

            roiControls.style.display = autoROIEnabled.checked ? 'block' : 'none';
            roiMarginValue.textContent = roiMargin.value + 'px';
            roiConfidenceValue.textContent = Math.round(roiConfidence.value * 100) + '%';
            roiMinWidthValue.textContent = roiMinWidth.value + 'px';
            roiMinHeightValue.textContent = roiMinHeight.value + 'px';
        }

        function drawROIOverlay(imageElement, roi) {
            const container = imageElement.parentElement;
            let overlayDiv = container.querySelector('.roi-overlay');
            if (!overlayDiv) {
                overlayDiv = document.createElement('div');
                overlayDiv.className = 'roi-overlay';
                container.style.position = 'relative';
                container.appendChild(overlayDiv);
            }
            overlayDiv.style.cssText = `
                position: absolute;
                left: ${roi.x}px;
                top: ${roi.y}px;
                width: ${roi.width}px;
                height: ${roi.height}px;
                border: 2px solid #00ff00;
                box-shadow: 0 0 10px rgba(0,255,0,0.5);
                pointer-events: none;
                z-index: 1000;
            `;
            setTimeout(() => overlayDiv && overlayDiv.parentElement && overlayDiv.remove(), 5000);
        }

        function updateROIPreview(roi) {
            const statusElement = document.getElementById('roiStatus');
            const confidenceElement = document.getElementById('roiConfidenceDisplay');
            const dimensionsElement = document.getElementById('roiDimensions');
            const previewCanvas = document.getElementById('roiPreviewCanvas');
            const ctx = previewCanvas.getContext('2d');
            
            if (!roi) {
                statusElement.textContent = 'No detectado';
                confidenceElement.textContent = '-';
                dimensionsElement.textContent = '-';
                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                return;
            }
            
            statusElement.textContent = 'Detectado';
            confidenceElement.textContent = Math.round(roi.confidence * 100) + '%';
            dimensionsElement.textContent = `${Math.round(roi.width)}x${Math.round(roi.height)} px`;
            
            if (currentImage.src) {
                previewCanvas.width = roi.width;
                previewCanvas.height = roi.height;
                ctx.drawImage(currentImage, roi.x, roi.y, roi.width, roi.height, 0, 0, roi.width, roi.height);
                ctx.strokeStyle = roi.confidence > 0.7 ? '#00ff00' : roi.confidence > 0.4 ? '#ffff00' : '#ff0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, roi.width, roi.height);
            }
        }

        function openManualROISelection() {
            const modal = document.getElementById('roiSelectionModal');
            const canvas = document.getElementById('roiSelectionCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!currentImage.src) {
                showNotification('Primero captura o carga una imagen', 'warning');
                return;
            }
            
            canvas.width = currentImage.width;
            canvas.height = currentImage.height;
            ctx.drawImage(currentImage, 0, 0);
            
            let isDrawing = false;
            let startX, startY;
            let currentRect = null;
            
            canvas.onmousedown = (e) => {
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                isDrawing = true;
                currentRect = null;
            };
            
            canvas.onmousemove = (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(currentImage, 0, 0);
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                currentRect = {
                    x: Math.min(startX, currentX),
                    y: Math.min(startY, currentY),
                    width: Math.abs(currentX - startX),
                    height: Math.abs(currentY - startY)
                };
            };
            
            canvas.onmouseup = () => {
                isDrawing = false;
                ctx.setLineDash([]);
            };
            
            canvas.ondblclick = () => {
                if (currentRect && currentRect.width > 50 && currentRect.height > 20) {
                    confirmManualROI(currentRect);
                }
            };
            
            document.getElementById('confirmROI').onclick = () => {
                if (currentRect && currentRect.width > 50 && currentRect.height > 20) {
                    confirmManualROI(currentRect);
                }
            };
            
            document.getElementById('cancelROI').onclick = () => {
                modal.style.display = 'none';
                canvas.onmousedown = null;
                canvas.onmousemove = null;
                canvas.onmouseup = null;
                canvas.ondblclick = null;
            };
            
            modal.style.display = 'block';
        }

        function confirmManualROI(rect) {
            processor.lastROI = { ...rect, confidence: 1.0, manual: true };
            updateROIPreview(processor.lastROI);
            document.getElementById('roiSelectionModal').style.display = 'none';
            showNotification('√Årea seleccionada manualmente', 'success');
        }

        async function testROIDetection() {
            if (!currentImage.src) {
                showNotification('Primero captura o carga una imagen', 'warning');
                return;
            }
            
            showNotification('Probando detecci√≥n de ROI...', 'info');
            try {
                const roi = await processor.detectPDF417ROI(currentImage);
                if (roi) {
                    updateROIPreview(roi);
                    showNotification(`ROI detectado con ${Math.round(roi.confidence * 100)}% de confianza`, 'success');
                    if (processor.config.autoROI.showDebugOverlay) drawROIOverlay(currentImage, roi);
                } else {
                    showNotification('No se pudo detectar el PDF417', 'warning');
                }
            } catch (error) {
                showNotification('Error en detecci√≥n: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== MANEJO DE ARCHIVOS ====================
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const img = new Image();
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                currentImage.src = canvas.toDataURL();
                currentImage.width = canvas.width;
                currentImage.height = canvas.height;
                processor.updateFromUI();
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                imageData = processor.processImage(imageData);
                overlay.width = canvas.width;
                overlay.height = canvas.height;
                overlayCtx.putImageData(imageData, 0, 0);
                const processedCanvas = document.createElement('canvas');
                processedCanvas.width = canvas.width;
                processedCanvas.height = canvas.height;
                const processedCtx = processedCanvas.getContext('2d');
                processedCtx.putImageData(imageData, 0, 0);
                showProcessing(true);
                try {
                    const result = await codeReader.decodeFromCanvas(processedCanvas);
                    showResults(result.text);
                } catch (err) {
                    console.log('No se pudo decodificar:', err);
                    showResults('No se detect√≥ c√≥digo PDF417. Intenta ajustar los filtros.');
                }
                showProcessing(false);
            };
            img.src = URL.createObjectURL(file);
        });

        // ==================== CONTROLES DE CONFIGURACI√ìN ====================
        document.getElementById('resetSettings').addEventListener('click', () => {
            processor.resetSettings();
            processor.updateUIFromConfig();
            showNotification('Configuraci√≥n restaurada a valores por defecto', 'info');
        });

        document.getElementById('saveSettings').addEventListener('click', () => {
            processor.updateFromUI();
            processor.saveSettings();
            showNotification('Configuraci√≥n guardada', 'success');
        });

        document.getElementById('loadSettings').addEventListener('click', () => {
            processor.loadSettings();
            processor.updateUIFromConfig();
            showNotification('Configuraci√≥n cargada', 'info');
        });

        // ==================== EVENT LISTENERS ====================
        startButton.addEventListener('click', startCamera);
        stopButton.addEventListener('click', stopCamera);
        captureButton.addEventListener('click', captureAndScan);
        toggleScanButton.addEventListener('click', toggleAutoScan);

        // ==================== INICIALIZACI√ìN ====================
        window.addEventListener('load', () => {
            processor.loadSettings();
            processor.updateUIFromConfig();
            initializeROIControls();
            updateROIPreview(null);
        });
    </script>
</body>
</html>